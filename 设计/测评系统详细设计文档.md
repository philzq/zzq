# 测评填单系统详细设计文档

## 文档信息

- **项目名称**：测评填单系统
- **版本**：v2.0
- **技术框架**：eladmin + Spring Boot
- **数据库**：MySQL 8.0+
- **文档日期**：2024年

---

## 1. 系统概述

### 1.1 项目背景

测评填单系统是一个支持多租户的SaaS系统，主要用于电商平台（如Coupang、Naver）的产品测评订单管理。系统支持管理员、员工和客户三种用户角色，提供店铺管理、产品管理、订单管理、财务账单等核心功能。

### 1.2 核心功能

- **账号管理**：管理员账号、员工账号、客户账号的创建和权限管理
- **平台管理**：支持多个电商平台（Coupang、Naver等）
- **店铺管理**：店铺的添加、修改、删除
- **产品管理**：产品的添加（自动/手动）、修改、查询
- **订单管理**：订单创建（测评、点击、加购）、查询（已完成、进行中、待确认、待开始）
- **财务账单**：订单佣金、充值、退款的财务管理
- **帮助文档**：使用帮助文档系统

### 1.3 系统特点

- **多租户架构**：支持多个客户租户，数据完全隔离
- **双用户体系**：系统用户（管理员/员工）和租户用户（客户）
- **双菜单体系**：系统菜单和租户菜单独立
- **双角色体系**：系统角色和租户角色独立
- **权限精细化**：基于RBAC的权限控制
- **无外键设计**：提高性能，由应用层保证数据一致性

---

## 2. 技术架构

### 2.1 技术栈

#### 后端技术栈
- **框架**：Spring Boot 2.x
- **数据库**：MySQL 8.0+
- **ORM**：JPA / MyBatis Plus
- **权限框架**：基于Spring Security的RBAC权限控制
- **缓存**：Redis
- **消息队列**：RabbitMQ（可选）
- **文件存储**：本地存储 / OSS
- **API文档**：Swagger / Knife4j

#### 前端技术栈
- **框架**：Vue 2.x / Vue 3.x
- **UI组件**：Element UI / Element Plus
- **状态管理**：Vuex
- **路由**：Vue Router
- **HTTP客户端**：Axios

### 2.2 系统架构

```
┌─────────────────────────────────────────────────────────┐
│                     前端层 (Vue)                         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐            │
│  │  系统管理 │  │  业务功能 │  │  租户功能 │            │
│  └──────────┘  └──────────┘  └──────────┘            │
└─────────────────────────────────────────────────────────┘
                        │
                        │ HTTP/HTTPS
                        ▼
┌─────────────────────────────────────────────────────────┐
│                   API网关层 (Gateway)                    │
│  权限验证 │ 路由转发 │ 限流 │ 日志                        │
└─────────────────────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────┐
│                   业务服务层 (Spring Boot)               │
│  ┌──────────────┐  ┌──────────────┐                   │
│  │  系统服务模块  │  │  业务服务模块  │                   │
│  │  - 用户管理   │  │  - 店铺管理   │                   │
│  │  - 角色管理   │  │  - 产品管理   │                   │
│  │  - 菜单管理   │  │  - 订单管理   │                   │
│  │  - 权限管理   │  │  - 账单管理   │                   │
│  └──────────────┘  └──────────────┘                   │
└─────────────────────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────┐
│                   数据持久层                             │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐            │
│  │   MySQL   │  │  Redis   │  │    OSS   │            │
│  └──────────┘  └──────────┘  └──────────┘            │
└─────────────────────────────────────────────────────────┘
```

### 2.3 项目结构（基于eladmin）

```
evaluation-system/
├── eladmin-common/          # 公共模块
│   ├── core/                # 核心配置
│   ├── exception/           # 异常处理
│   ├── log/                 # 日志处理
│   └── utils/               # 工具类
├── eladmin-system/          # 系统模块
│   ├── domain/              # 实体类
│   ├── repository/          # 数据访问层
│   ├── service/             # 业务逻辑层
│   └── rest/                # 控制器层
├── eladmin-business/        # 业务模块
│   ├── domain/              # 实体类
│   ├── repository/          # 数据访问层
│   ├── service/             # 业务逻辑层
│   └── rest/                # 控制器层
├── eladmin-security/        # 安全模块
│   ├── config/              # 安全配置
│   ├── filter/              # 过滤器
│   └── service/             # 认证服务
└── eladmin-generator/       # 代码生成器
```

---

## 3. 数据库设计

### 3.1 数据库概述

数据库采用MySQL 8.0+，字符集utf8mb4，排序规则utf8mb4_unicode_ci。所有表均使用InnoDB存储引擎。

### 3.2 核心表结构

#### 3.2.1 系统核心表

| 表名 | 说明 | 关键字段 |
|------|------|----------|
| sys_tenant | 租户表 | tenant_id, tenant_name, company_name |
| sys_user | 用户表 | user_id, tenant_id, username, is_admin |
| sys_menu | 菜单表 | menu_id, menu_type, pid, title |
| sys_role | 角色表 | role_id, tenant_id, name, is_system |
| sys_users_roles | 用户角色关联表 | user_id, role_id |
| sys_roles_menus | 角色菜单关联表 | role_id, menu_id |

#### 3.2.2 业务表

| 表名 | 说明 | 关键字段 |
|------|------|----------|
| sys_platform | 平台表 | platform_id, platform_code, platform_name |
| bt_shop | 店铺表 | shop_id, tenant_id, shop_kr_name, platform_id |
| bt_product | 产品表 | product_id, tenant_id, shop_id, product_title |
| sys_order_type | 订单类型表 | type_id, type_name, commission_rate |
| bt_order | 订单主表 | order_id, tenant_id, shop_id, order_status |
| bt_order_detail | 订单明细表 | detail_id, order_id, product_id, date |
| bt_bill | 财务账单表 | bill_id, tenant_id, bill_type, amount |
| sys_help_doc | 帮助文档表 | doc_id, menu_id, title, content |

### 3.3 数据隔离机制

- **租户数据隔离**：所有业务表（bt_*）包含tenant_id字段，查询时必须加上tenant_id条件
- **系统数据隔离**：sys_user通过tenant_id区分系统用户和租户用户
- **全局共享数据**：sys_platform、sys_order_type、sys_help_doc为全局共享

---

## 4. 功能模块详细设计

### 4.1 账号管理模块

#### 4.1.1 管理员账号

**功能描述**：
- 创建员工账号
- 编辑各种权限
- 编辑和修改各种输入字段
- 查看所有客户订单数据
- 创建客户账号

**权限说明**：
- 系统超管（is_admin=1, tenant_id=NULL）
- 拥有系统最高权限
- 可管理所有租户数据

**接口设计**：

```java
// 创建员工账号
POST /api/system/user
{
    "username": "employee001",
    "nickName": "员工001",
    "email": "employee001@example.com",
    "phone": "13800138000",
    "password": "123456",
    "enabled": true,
    "roles": [2]  // 员工角色ID
}

// 创建客户账号（租户）
POST /api/system/tenant
{
    "tenantName": "客户公司A",
    "companyName": "客户公司A",
    "contactPerson": "张三",
    "contactPhone": "13800138000",
    "contactEmail": "zhangsan@example.com",
    "managerWechat": "zhangsan_wx",
    "username": "customer001",  // 租户管理员账号
    "password": "123456"
}

// 查询所有客户订单数据
GET /api/business/order/all?page=0&size=10
```

#### 4.1.2 员工账号

**功能描述**：
- 查看所有客户订单数据
- 创建客户账号

**权限说明**：
- 系统员工（is_admin=0, tenant_id=NULL）
- 由系统超管分配角色和权限
- 使用系统菜单

**接口设计**：

```java
// 查看所有客户订单数据
GET /api/business/order/all?page=0&size=10

// 创建客户账号
POST /api/system/tenant
{
    "tenantName": "客户公司B",
    "companyName": "客户公司B",
    "contactPerson": "李四",
    "contactPhone": "13900139000",
    "contactEmail": "lisi@example.com",
    "managerWechat": "lisi_wx",
    "username": "customer002",
    "password": "123456"
}
```

#### 4.1.3 客户账号

**功能描述**：
- 创建子账号
- 为子账号分配各种权限
- 首次登录需短信/邮箱验证后设置密码

**权限说明**：
- 租户管理员（is_admin=1, tenant_id!=NULL）
- 租户员工（is_admin=0, tenant_id!=NULL）
- 使用租户菜单
- 只能访问本租户数据

**接口设计**：

```java
// 创建子账号
POST /api/system/user
{
    "username": "subuser001",
    "nickName": "子账号001",
    "email": "subuser001@example.com",
    "phone": "13700137000",
    "password": "123456",
    "enabled": true,
    "roles": [10]  // 租户员工角色ID
}

// 首次登录验证
POST /api/auth/verify
{
    "phone": "13700137000",
    "code": "123456"
}

// 设置密码
POST /api/auth/set-password
{
    "phone": "13700137000",
    "password": "newpassword123"
}
```

### 4.2 平台管理模块

#### 4.2.1 功能描述

- 系统管理员可添加、编辑平台
- 客户只读查看平台列表
- 当前支持：Coupang、Naver

#### 4.2.2 接口设计

```java
// 查询平台列表（所有用户）
GET /api/system/platform/list

// 添加平台（仅系统管理员）
POST /api/system/platform
{
    "platformCode": "coupang",
    "platformName": "Coupang",
    "platformIcon": "https://example.com/coupang.png",
    "description": "韩国最大电商平台",
    "sort": 1,
    "enabled": true
}

// 修改平台（仅系统管理员）
PUT /api/system/platform/{id}
{
    "platformName": "Coupang更新",
    "enabled": true
}

// 删除平台（仅系统管理员）
DELETE /api/system/platform/{id}
```

### 4.3 店铺管理模块

#### 4.3.1 添加店铺

**功能描述**：
- 输入店铺韩文名称
- 输入自定义备注名称
- 选择平台

**接口设计**：

```java
// 添加店铺
POST /api/business/shop
{
    "shopKrName": "테스트샵",
    "shopCustomName": "测试店铺1",
    "platformId": 1
}
```

#### 4.3.2 修改店铺名称

**功能描述**：
- 仅支持修改自定义备注名称
- 仅客户管理员账号有此权限

**接口设计**：

```java
// 修改店铺名称
PUT /api/business/shop/{id}/name
{
    "shopCustomName": "测试店铺1-修改"
}
```

#### 4.3.3 删除店铺

**功能描述**：
- 客户端删除（逻辑删除，管理员仍可见）
- 如果店铺已生成订单：管理员可见，客户不可见
- 如果店铺未生成订单：永久删除

**接口设计**：

```java
// 删除店铺（客户端）
DELETE /api/business/shop/{id}

// 彻底删除店铺（系统管理员，仅未生成订单的店铺）
DELETE /api/business/shop/{id}/force
```

### 4.4 产品管理模块

#### 4.4.1 添加产品

**自动添加**：

```java
// 通过产品链接自动添加
POST /api/business/product/auto
{
    "productUrl": "https://www.coupang.com/vp/products/123456",
    "shopId": 1
}
```

**手动添加**：

```java
// 手动添加产品
POST /api/business/product
{
    "shopId": 1,
    "productTitle": "测试产品标题",
    "platformProductId": "PROD123456",
    "attributeNames": "颜色,尺寸,型号",
    "mainImage": "https://example.com/image.jpg",
    "salePrice": 29900.00
}
```

#### 4.4.2 修改产品

**功能描述**：
- 可按店铺或产品ID查询
- 除产品ID外，其他信息可编辑
- 已产生订单的产品信息修改后不会影响已有订单

**接口设计**：

```java
// 查询产品列表
GET /api/business/product?shopId=1&keyword=测试

// 修改产品
PUT /api/business/product/{id}
{
    "productTitle": "测试产品标题-修改",
    "attributeNames": "颜色,尺寸",
    "salePrice": 29900.00
}

// 查询产品详情
GET /api/business/product/{id}
```

### 4.5 订单管理模块

#### 4.5.1 创建订单

**订单类型**：
1. **测评订单**（Evaluation）
   - 单个产品单日订单
   - 不同产品单日订单
   - 单个产品多日订单
   - 不同产品多日订单

2. **点击订单**（Click）
   - 特定产品短期内总点击数
   - 多个产品短期内总点击数

3. **加购订单**（Add to Cart）
   - 特定产品未来期间加购总数
   - 多个产品短期内加购总数

**接口设计**：

```java
// 创建测评订单
POST /api/business/order/evaluation
{
    "shopId": 1,
    "typeId": 1,
    "products": [
        {
            "productId": 1,
            "keywords": "关键词1,关键词2",
            "dates": ["2024-01-01", "2024-01-02"],
            "dayQuantity": 5
        }
    ],
    "totalAmount": 100000.00,
    "remark": "测试订单"
}

// 创建点击订单
POST /api/business/order/click
{
    "shopId": 1,
    "typeId": 2,
    "products": [
        {
            "productId": 1,
            "totalClicks": 1000
        }
    ],
    "totalAmount": 50000.00
}

// 创建加购订单
POST /api/business/order/add-to-cart
{
    "shopId": 1,
    "typeId": 3,
    "products": [
        {
            "productId": 1,
            "totalQuantity": 500
        }
    ],
    "totalAmount": 30000.00
}
```

#### 4.5.2 查询订单

**订单状态**：
- **待开始**（0）：已填写但未到开始日期
- **进行中**（1）：今日订单，任务已分配
- **待确认**（2）：尚未审核/评价
- **已完成**（3）：已评价并结束
- **已取消**（4）：订单已取消

**接口设计**：

```java
// 查询订单列表
GET /api/business/order?status=1&page=0&size=10

// 查询待开始订单
GET /api/business/order/pending-start?page=0&size=10

// 查询待确认订单
GET /api/business/order/pending-confirm?page=0&size=10

// 查询进行中订单
GET /api/business/order/in-progress?page=0&size=10

// 查询已完成订单
GET /api/business/order/completed?page=0&size=10

// 查询订单详情
GET /api/business/order/{id}
```

### 4.6 财务账单模块

#### 4.6.1 功能描述

- 提交订单时需根据订单类型支付佣金
- 账单类型：订单佣金、充值、退款
- 支持支付记录查询

#### 4.6.2 接口设计

```java
// 查询账单列表
GET /api/business/bill?billType=1&page=0&size=10

// 创建订单佣金账单（自动）
POST /api/business/bill/commission
{
    "orderId": 1,
    "amount": 10000.00
}

// 充值
POST /api/business/bill/recharge
{
    "amount": 50000.00,
    "paymentMethod": "微信支付",
    "remark": "账户充值"
}

// 退款
POST /api/business/bill/refund
{
    "orderId": 1,
    "amount": 10000.00,
    "remark": "订单取消退款"
}

// 查询账户余额
GET /api/business/bill/balance
```

### 4.7 帮助文档模块

#### 4.7.1 功能描述

- 全局共享，所有用户共用
- 支持分类、标签、全文搜索
- 支持关联菜单，实现上下文帮助
- 支持用户反馈统计

#### 4.7.2 接口设计

```java
// 查询帮助文档列表
GET /api/system/help-doc?category=快速开始&page=0&size=10

// 查询帮助文档详情
GET /api/system/help-doc/{id}

// 搜索帮助文档
GET /api/system/help-doc/search?keyword=订单

// 查询关联菜单的帮助文档
GET /api/system/help-doc/menu/{menuId}

// 反馈帮助文档（有帮助/无帮助）
POST /api/system/help-doc/{id}/feedback
{
    "helpful": true
}
```

---

## 5. 权限设计

### 5.1 权限体系架构

系统采用RBAC（基于角色的访问控制）权限模型：

```
用户 (User) → 角色 (Role) → 菜单 (Menu) → 权限 (Permission)
```

### 5.2 用户类型与权限

#### 5.2.1 系统用户（tenant_id IS NULL）

| 用户类型 | is_admin | 权限说明 |
|---------|----------|----------|
| 系统超管 | 1 | 拥有系统最高权限，可管理所有租户数据 |
| 系统员工 | 0 | 由系统超管分配角色，使用系统菜单 |

#### 5.2.2 租户用户（tenant_id IS NOT NULL）

| 用户类型 | is_admin | 权限说明 |
|---------|----------|----------|
| 租户超管 | 1 | 拥有该租户的最高权限，可管理租户内所有数据 |
| 租户员工 | 0 | 由租户超管分配角色，使用租户菜单 |

### 5.3 菜单权限

- **系统菜单**（menu_type=1）：供系统用户使用
- **租户菜单**（menu_type=2）：供租户用户使用

### 5.4 数据权限

- **系统用户**：可访问所有租户数据（管理需要）
- **租户用户**：只能访问本租户数据（通过tenant_id隔离）

### 5.5 权限校验流程

```
1. 用户登录 → 获取Token
2. 请求接口 → Token验证
3. 获取用户信息 → 判断用户类型（系统用户/租户用户）
4. 获取用户角色 → 判断角色类型（系统角色/租户角色）
5. 获取角色菜单 → 判断菜单类型（系统菜单/租户菜单）
6. 校验数据权限 → 系统用户可跨租户，租户用户只能本租户
7. 执行业务逻辑
```

---

## 6. API接口设计规范

### 6.1 RESTful API规范

- **GET**：查询资源
- **POST**：创建资源
- **PUT**：更新资源（完整更新）
- **PATCH**：更新资源（部分更新）
- **DELETE**：删除资源

### 6.2 统一响应格式

```json
{
    "code": 200,
    "message": "操作成功",
    "data": {},
    "timestamp": "2024-01-01 12:00:00"
}
```

### 6.3 统一异常处理

```json
{
    "code": 400,
    "message": "参数错误",
    "data": null,
    "timestamp": "2024-01-01 12:00:00"
}
```

### 6.4 分页响应格式

```json
{
    "code": 200,
    "message": "操作成功",
    "data": {
        "content": [],
        "totalElements": 100,
        "totalPages": 10,
        "size": 10,
        "number": 0
    },
    "timestamp": "2024-01-01 12:00:00"
}
```

---

## 7. 核心业务流程

### 7.1 用户注册流程

```
1. 系统管理员创建客户账号
   ↓
2. 系统自动创建租户（sys_tenant）
   ↓
3. 系统自动创建租户管理员（sys_user, tenant_id=租户ID, is_admin=1）
   ↓
4. 租户管理员首次登录
   ↓
5. 短信/邮箱验证
   ↓
6. 设置密码
   ↓
7. 登录成功，获取租户菜单
```

### 7.2 订单创建流程

```
1. 选择店铺
   ↓
2. 选择订单类型（测评/点击/加购）
   ↓
3. 选择产品
   ↓
4. 填写订单信息（日期、数量、关键词等）
   ↓
5. 计算订单金额和佣金
   ↓
6. 创建订单（bt_order）
   ↓
7. 创建订单明细（bt_order_detail，按日期拆分）
   ↓
8. 创建账单（bt_bill，订单佣金类型）
   ↓
9. 扣减账户余额
   ↓
10. 返回订单信息
```

### 7.3 店铺删除流程

```
1. 客户端删除店铺
   ↓
2. 检查店铺是否有订单
   ↓
3. 有订单：
   - 标记为客户端删除（逻辑删除）
   - 管理员仍可见
   - 客户不可见
   ↓
4. 无订单：
   - 永久删除
   - 管理员和客户均不可见
```

---

## 8. 安全设计

### 8.1 认证机制

- **JWT Token**：用户登录后获取Token，后续请求携带Token
- **Token刷新**：Token过期前可刷新
- **多设备登录**：支持同一账号多设备登录（可配置）

### 8.2 授权机制

- **RBAC权限控制**：基于角色的权限控制
- **数据权限隔离**：租户数据通过tenant_id隔离
- **API权限控制**：基于菜单权限标识控制API访问

### 8.3 数据安全

- **SQL注入防护**：使用参数化查询
- **XSS防护**：输入输出过滤
- **CSRF防护**：Token验证
- **密码加密**：BCrypt加密存储

### 8.4 审计日志

- 记录用户登录日志
- 记录数据变更日志
- 记录权限变更日志
- 记录跨租户数据访问日志

---

## 9. 性能优化

### 9.1 数据库优化

- **索引优化**：合理使用单字段索引和复合索引
- **查询优化**：避免全表扫描，使用分页查询
- **连接池**：使用Druid连接池

### 9.2 缓存策略

- **菜单缓存**：按用户类型缓存菜单数据
- **权限缓存**：缓存用户权限信息
- **全局数据缓存**：平台、订单类型等全局数据缓存
- **Redis缓存**：使用Redis作为缓存中间件

### 9.3 接口优化

- **接口限流**：防止接口被恶意调用
- **异步处理**：耗时操作异步处理
- **批量操作**：支持批量创建、更新、删除

---

## 10. 部署方案

### 10.1 环境要求

- **JDK**：1.8+
- **MySQL**：8.0+
- **Redis**：5.0+
- **Nginx**：1.18+

### 10.2 部署架构

```
                    Nginx (80/443)
                         │
          ┌──────────────┼──────────────┐
          │              │              │
    Backend API    Frontend      Static Files
    (Spring Boot)   (Vue)        (OSS/本地)
          │
    ┌─────┴─────┐
    │           │
  MySQL      Redis
```

### 10.3 配置文件

- **application.yml**：应用配置
- **application-dev.yml**：开发环境配置
- **application-prod.yml**：生产环境配置

---

## 11. 测试方案

### 11.1 单元测试

- Service层单元测试
- Repository层单元测试
- 使用JUnit + Mockito

### 11.2 集成测试

- API接口集成测试
- 数据库集成测试
- 使用Spring Boot Test

### 11.3 功能测试

- 用户登录测试
- 权限控制测试
- 业务流程测试

---

## 12. 开发规范

### 12.1 代码规范

- 遵循阿里巴巴Java开发手册
- 使用Lombok简化代码
- 统一异常处理
- 统一响应格式

### 12.2 命名规范

- **类名**：大驼峰（PascalCase）
- **方法名/变量名**：小驼峰（camelCase）
- **常量名**：大写下划线（UPPER_SNAKE_CASE）
- **数据库表名**：小写下划线（snake_case）

### 12.3 注释规范

- 类注释：说明类的用途
- 方法注释：说明方法的功能、参数、返回值
- 复杂业务逻辑：添加行内注释

---

## 13. 附录

### 13.1 数据字典

详见数据库设计文档中的表结构说明。

### 13.2 错误码定义

| 错误码 | 说明 |
|--------|------|
| 200 | 成功 |
| 400 | 参数错误 |
| 401 | 未授权 |
| 403 | 无权限 |
| 404 | 资源不存在 |
| 500 | 服务器错误 |

### 13.3 参考资料

- eladmin框架文档：https://el-admin.vip
- Spring Boot官方文档：https://spring.io/projects/spring-boot
- Vue官方文档：https://vuejs.org
- Element UI文档：https://element.eleme.io

---

**文档版本历史**

| 版本 | 日期 | 修改内容 | 修改人 |
|------|------|----------|--------|
| v1.0 | 2024-01-01 | 初始版本 | - |
| v2.0 | 2024-01-01 | 基于思维导图完善设计 | - |

